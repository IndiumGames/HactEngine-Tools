#!/usr/bin/env python

# Update tools

import argparse
import multiprocessing
import os
import platform
#import re
import subprocess
import sys

print "System info"
print "==========="
print "OS name:            " + os.name
print "Platform:           " + platform.system()
print "Linux distribution: " + platform.linux_distribution()[0]
print "CPU cores:          " + str(multiprocessing.cpu_count())
print


if os.name != "posix":
    sys.exit("! Non-POSIX system not supported (Windows?)")
elif platform.system() != "Linux":
    sys.exit("! Non-Linux system not supported (OS X?)")


# Available arguments
parser = argparse.ArgumentParser("update-tools")
parser.add_argument(
    "--no-compile",
    action="store_true",
    help="Only download, do not install tools"
)

# Parse arguments
args = parser.parse_args()


# Amount of jobs to use when building
make_jobs = "-j" + str(multiprocessing.cpu_count())

# The directory containing this script
scriptDir = os.path.dirname(os.path.realpath(__file__))

# The directory to use as the temporary directory
tempDir = scriptDir + "/temp"

# Create temp directory if it doesn't exist
if not os.path.exists(tempDir):
    os.makedirs(tempDir)

os.chdir(tempDir)

# The prefix directory
prefixDir = tempDir + "/_prefix"

# Create prefix directory if it doesn't exist
if not os.path.exists(prefixDir):
    os.makedirs(prefixDir)


#!
#! Do a shallow Git clone.
#!
#! :param url:        URL to clone from.
#! :param directory:  Directory to clone into (relative to temp dir).
#!
def GitShallowClone(url, directory):
    # Get GNU Readline
    output = subprocess.check_output(
        "git clone --depth=1 --branch=master " + url + " " + directory,
        cwd = tempDir,
        stderr = subprocess.STDOUT,
        shell = True
    )
    
    return output


#!
#! Get dependency.
#!
def GetDependency(directory, gitUrl, compileCommands, downloadCommands = None):
    if os.path.exists(tempDir + "/" + directory):
        print "### Skipping " + directory + " because directory exists: temp/" + directory
    else:
        print("### Clone " + directory)
        
        if gitUrl != "":
            # Get GNU Readline
            GitShallowClone(gitUrl, directory)
        
        if downloadCommands:
            print("    ### Download " + directory)
            
            for downloadCommand in downloadCommands:
                print("        ### Running download command: " + downloadCommand)
                
                output = subprocess.check_output(
                    downloadCommand,
                    cwd = tempDir,
                    shell = True
                )
                #print output
        
        if not args.no_compile:
            print("    ### Compile " + directory)
            
            for compileCommand in compileCommands:
                print("        ### Running compile command: " + compileCommand)
                
                output = subprocess.check_output(
                    compileCommand,
                    cwd = tempDir + "/" + directory,
                    shell = True
                )
                #print output
    
    print


# Get and compile GNU Readline (for Lua)
GetDependency(
    "readline",
    "git://git.savannah.gnu.org/readline.git",
    [
        "./configure",
        "make " + make_jobs
    ]
)

# Get and compile Lua
GetDependency(
    "lua",
    "https://github.com/lua/lua.git",
    [
        "cd src; make " + make_jobs + " all SYSCFLAGS=\"-DLUA_USE_LINUX\" CFLAGS=\"-I../..\" SYSLIBS=\"-Wl,-E -ldl -L../../readline -lreadline\""
    ]
)


# Get GLM
GetDependency(
    "GLM",
    "https://github.com/g-truc/glm.git",
    [
        # No compile necessary, this is a header only library
    ]
)


# Get and compile Luacheck
GetDependency(
    "luacheck",
    "https://github.com/mpeterv/luacheck.git",
    [
        "../lua/src/lua install.lua " + prefixDir
    ]
)


# SWIG is difficult to compile without installing some dependencies
if platform.linux_distribution()[0] == "Ubuntu":
    print "Install these dependencies:"
    print "sudo apt-get install build-essential libtool libpcre3-dev perl-byacc"
    print "sudo apt-get install yodl"
    print

# Get and compile PCRE (for SWIG)
#GetDependency(
#    "pcre",
#    "https://gitlab.com/tortoisegit/pcre.git",
#    [
#        "./autogen.sh",
#        "./configure",
#        "make"
#    ]
#)

# Get and compile SWIG
GetDependency(
    "SWIG",
    "https://github.com/swig/swig.git",
    [
        "./autogen.sh",
        "./configure --prefix=" + prefixDir,
        "make " + make_jobs,
        "make install"
    ]
)


# These are not something I want to even try to compile myself...
if platform.linux_distribution()[0] == "Ubuntu":
    print "Install these dependencies:"
    print "sudo apt-get install libtool"
    print "sudo apt-get install libgles2-mesa-dev"
    print "#sudo apt-get install libdbus-1-dev libibus-1.0-dev"
    print

# Get and compile SDL2
GetDependency(
    "SDL2",
    "https://github.com/spurious/SDL-mirror.git",
    [
        "./autogen.sh",
        "./configure --prefix=" + prefixDir,
        "make " + make_jobs,
        "make install"
    ]
)


# Get and compile zlib (needed by libpng, needed by SDL2_image)
GetDependency(
    "zlib",
    "",
    [
        "./configure --prefix=" + prefixDir,
        "make " + make_jobs,
        "make install"
    ],
    [
        "curl -sLO http://zlib.net/zlib-1.2.8.tar.gz",
        "tar xf zlib-1.2.8.tar.gz",
        "mv zlib-1.2.8 zlib"
    ]
)

# Get and compile libpng (needed by SDL2_image)
GetDependency(
    "libpng",
    "",
    [
        "./configure --prefix=" + prefixDir,
        "make " + make_jobs,
        "make install"
    ],
    [
        "curl -sLO http://download.sourceforge.net/libpng/libpng-1.2.52.tar.gz",
        "tar xf libpng-1.2.52.tar.gz",
        "mv libpng-1.2.52 libpng"
    ]
)

# Get and compile libjpeg (needed by SDL2_image)
GetDependency(
    "libjpeg",
    "",
    [
        "./configure --prefix=" + prefixDir,
        "make " + make_jobs,
        "make install"
    ],
    [
        "curl -sLO http://www.ijg.org/files/jpegsrc.v9a.tar.gz",
        "tar xf jpegsrc.v9a.tar.gz",
        "mv jpeg-9a libjpeg"
    ]
)

# Get and compile libtiff (needed by SDL2_image)
GetDependency(
    "libtiff",
    "",
    [
        "./configure --prefix=" + prefixDir,
        "make " + make_jobs,
        "make install"
    ],
    [
        "curl -sLO ftp://ftp.remotesensing.org/pub/libtiff/tiff-4.0.6.tar.gz",
        "tar xf tiff-4.0.6.tar.gz",
        "mv tiff-4.0.6 libtiff"
    ]
)

# These are not something I want to even try to compile myself...
if platform.linux_distribution()[0] == "Ubuntu":
    print "Install these dependencies:"
    print "sudo apt-get install libtool"
    print

# Get and compile SDL2_image
GetDependency(
    "SDL2_image",
    "",
    [
        "./autogen.sh",
        "PATH=\"$PATH:../_prefix/bin\" CFLAGS=\"-I../_prefix/include\" C_INCLUDE_PATH=\"../_prefix/include\" ./configure --prefix=" + prefixDir,
        "make " + make_jobs,
        "make install"
    ],
    [
        "curl -sLO https://www.libsdl.org/projects/SDL_image/release/SDL2_image-2.0.0.tar.gz",
        "tar xf SDL2_image-2.0.0.tar.gz",
        "mv SDL2_image-2.0.0 SDL2_image"
    ]
)

