#!/usr/bin/env python

# Update tools

import argparse
#import re
import os
import platform
import subprocess
import sys


if os.name != "posix":
    sys.exit("! Non-POSIX system not supported (Windows?)")
elif platform.system() != "Linux":
    sys.exit("! Non-Linux system not supported (OS X?)")


# Available arguments
parser = argparse.ArgumentParser("update-tools")
parser.add_argument(
    "--no-compile",
    action="store_true",
    help="Only download, do not install tools"
)

# Parse arguments
args = parser.parse_args()


# The directory containing this script
scriptDir = os.path.dirname(os.path.realpath(__file__))

# The directory to use as the temporary directory
tempDir = scriptDir + "/temp"

# Create temp directory if it doesn't exist
if not os.path.exists(tempDir):
    os.makedirs(tempDir)


#!
#! Do a shallow Git clone.
#!
#! :param url:        URL to clone from.
#! :param directory:  Directory to clone into (relative to temp dir).
#!
def GitShallowClone(url, directory):
    # Get GNU Readline
    output = subprocess.check_output(
        "git clone --depth=1 --branch=master " + url + " " + directory,
        cwd = tempDir,
        stderr = subprocess.STDOUT,
        shell = True
    )
    
    return output


#!
#! Get dependency.
#!
def GetDependency(directory, gitUrl, compileCommands):
    if os.path.exists(tempDir + "/" + directory):
        print "### Skipping " + directory + " because directory exists: temp/" + directory
    else:
        print("### Clone " + directory)
        
        # Get GNU Readline
        GitShallowClone(gitUrl, directory)
        
        if not args.no_compile:
            print("    ### Compile " + directory)
            
            for compileCommand in compileCommands:
                print("        ### Running compile command: " + compileCommand)
                
                output = subprocess.check_output(
                    compileCommand,
                    cwd = tempDir + "/" + directory,
                    shell = True
                )
                #print output
    
    print


# Get and compile GNU Readline
GetDependency(
    "readline",
    "git://git.savannah.gnu.org/readline.git",
    [
        "./configure",
        "make"
    ]
)

# Get and compile Lua
GetDependency(
    "lua",
    "https://github.com/lua/lua.git",
    [
        "cd src; make all SYSCFLAGS=\"-DLUA_USE_LINUX\" CFLAGS=\"-I../..\" SYSLIBS=\"-Wl,-E -ldl -L../../readline -lreadline\""
    ]
)

# Get and compile Luacheck
GetDependency(
    "luacheck",
    "https://github.com/mpeterv/luacheck.git",
    [
        "../lua/src/lua install.lua ./install"
    ]
)

